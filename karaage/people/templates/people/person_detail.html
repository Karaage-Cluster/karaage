{% extends "main.html" %}
{% load url from future %}
{% load machines %}


{% block title %}Person{% endblock %}


{% block extrahead %}
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/karaage.js"></script>
{% if is_admin %}
{{ form.media }}
{% endif %}
{% endblock %}


{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href='{% url "index" %}'>Home</a>&nbsp;›
    <a href="{% url 'kg_person_list' %}">People</a>&nbsp;›
    {{ person }}
</div>
{% endblock %}


{% block content %}
<div id="content-main">

    <div class="module">
        <h2>Person</h2>

        <h3>
            {% if person.title %}{{ person.title }}{% endif %} {{ person }}
            {% if not person.is_active %}
            <img alt="Not Active" src="{{ STATIC_URL }}img/icon-no.gif" title="Not Active"/>
            {% elif person.is_locked %}
            <img alt="locked" src="{{ STATIC_URL }}img/lock.png"/>
            {% else %}
            <img alt="Active" src="{{ STATIC_URL }}img/icon-yes.gif" title="Active"/>
            {% endif %}
        </h3>

        <table>
            {% if person.deleted_by %}
            <tr><td colspan="2">Deleted by {{ person.deleted_by }} on {{ person.date_deleted }}</td></tr>
            {% endif %}
            <tr><td>Email:</td><td>{{ person.email|urlize }}</td></tr>
            <tr><td>Position:</td><td>{{ person.position|default:"" }}</td></tr>
            <tr><td>Department:</td><td>{{ person.department|default:"" }}</td></tr>
            <tr><td>Supervisor:</td><td>{{ person.supervisor|default:"" }}</td></tr>
            <tr>
              <td>Institute:</td>
              <td>
                <a href="{{ person.institute.get_absolute_url }}">{{ person.institute }}</a>
              </td>
            </tr>
            <tr>
              <td>Insitutes (extra):</td>
              <td>
                {% for institute in person.institutes.all %}
                <a href="{{ institute.get_absolute_url }}">{{ institute }}</a>
                {% if not forloop.last %}, {% endif %}
                {% endfor %}
              </td>
            </tr>

            <tr>
              <td>Phone:</td>
              <td>{{ person.telephone|default:"" }}</td>
            </tr>

            {% if person.mobile %}
            <tr>
              <td>Mobile:</td><td>{{ person.mobile|default:"" }}</td>
            </tr>
            {% endif %}

            <tr>
              <td>Groups:</td>
              <td>
                {% for group in person.groups.all %}
                {% if is_admin %}
                <a href="{{ group.get_absolute_url }}">{{ group }}</a>
                {% else %}
                {{ group }}
                {% endif %}
                {% if not forloop.last %}, {% endif %}
                {% endfor %}
              </td>
            </tr>

            <tr>
              <td>Projects:</td>
              <td>
                {% for project in person.projects.all %}
                <a href="{{ project.get_absolute_url }}">{{ project }}</a>
                {% if not forloop.last %}, {% endif %}
                {% endfor %}
              </td>
            </tr>

            <tr>
              <td>Software:</td>
              <td>
                {% for software in person.software.all %}
                <a href="{{ software.get_absolute_url }}">{{ software }}</a>
                {% if not forloop.last %}, {% endif %}
                {% endfor %}
              </td>
            </tr>
            <tr id="hidden-link">
              <td colspan="2">
                <a href="#" onclick="showHidden()">More....</a>
              </td>
            </tr>
        </table>

        <table id="hidden" style="display: none">
            <tr><td>Fax:</td><td>{{ person.fax }}</td></tr>
            <tr><td>Address:</td><td>{{ person.address|linebreaksbr|default:"" }}</td></tr>
            <tr><td>Country:</td><td>{{ person.get_country_display|default:"" }}</td></tr>
            {% if is_admin %}
            <tr><td>Comment:</td><td>{{ person.comment|default:"" }}</td></tr>
            <tr><td>Approved by:</td><td>{{ person.approved_by }}</td></tr>
            <tr><td>Date Approved:</td><td>{{ person.date_approved|date }}</td></tr>
            {% if person.deleted_by %}
            <tr><td>Deleted by:</td><td>{{ person.deleted_by }}</td></tr>
            <tr><td>Date Deleted:</td><td>{{ person.date_deleted|date }}</td></tr>
            {% endif %}
            <tr><td>Username:</td><td>{{ person.username }}</td></tr>
            {% if person.saml_id %}
            <tr><td>SAML ID:</td><td>{{ person.saml_id }}</td></tr>
            {% endif %}
            {% endif %}
        </table>
        {% if person.is_active or is_admin %}
        <h3>Person actions</h3>
        <div class="object-tools">
            <ul>
                {% if person.is_active %}

                    <li><a href="{% url 'kg_usage_job_list' %}?person={{ person.username }}">Display all jobs</a></li>

                    {% if is_admin %}

                        <li><a href="{% url 'kg_person_logs' person.username %}">Logs</a></li>
                        <li><a href="{% url 'kg_person_verbose' person.username %}">Verbose</a></li>
                        <li class="changelink"><a href="{% url 'kg_person_edit' person.username %}">Edit details</a></li>
                        <li class="deletelink"><a href="{%url 'kg_person_delete' person.username %}">Delete</a></li>
                        {% if person.is_locked %}
                        <li class="unlocklink">
                            <a href="{% url 'kg_person_unlock' person.username %}">Unlock</a>
                        </li>
                        {% else %}
                        <li class="locklink">
                            <a href="{% url 'kg_person_lock' person.username %}">Lock</a>
                        </li>
                        <li><a href="{% url 'kg_person_reset' person.username %}">Reset Password</a></li>
                        <li class="changelink"><a href="{% url 'kg_person_password' person.username %}">Change Password</a></li>
                        {% endif %}
                        <li><a href="{% url 'kg_person_bounce' person.username %}">Bounced Email</a></li>

                    {% else %}

                        <li><a href="{% url 'kg_person_reset' person.username %}">Reset Password</a></li>

                    {% endif %}

                {% else %}

                    {% if is_admin and not person.is_active %}
                    <li><a href="activate/">Activate</a></li>
                    {% endif %}


                {% endif %}

            </ul>
        </div>
        {% endif %}
    </div>


    {% if person.leaders.all %}
    <div class="module">
        <h2>Leader of Projects</h2>
        {% gen_table person.leaders.all %}
    </div>
    {% endif %}

    {% for ua in person.account_set.all %}
    <div class="module">
        <h2>{{ ua.machine_category }} Account</h2>
        <h3>Account</h3>
        <table cellspacing="0">
            <thead>
                <tr>
                    <th>Active</th>
                    <th>Username</th>
                    <th>Date Created</th>
                    <th>Date Deleted</th>
                    <th>Shell</th>
                </tr>
            </thead>
            <tbody>
                <tr class="row1">
                    <td>
                        {% if ua.date_deleted %}
                        <img alt="Not Active" src="{{ STATIC_URL }}img/icon-no.gif" title="Not Active"/>
                        {% else %}
                        {% if ua.is_locked %}
                        <img alt="locked" src="{{ STATIC_URL }}img/lock.png"/>
                        {% else %}
                        <img alt="Active" src="{{ STATIC_URL }}img/icon-yes.gif" title="Active"/>
                        {% endif %}
                        {% endif %}
                    </td>
                    <td>{{ ua.username }}</td>
                    <td>{{ ua.date_created|date }}</td>
                    <td>{{ ua.date_deleted|date }}</td>
                    <td>
                        {{ ua.shell }}
                        {% if not ua.date_deleted and is_admin %}
                        <form action="{% url 'kg_account_shell' ua.pk %}" method="post">{% csrf_token %}
                            <div>
                                {% shell_field ua %}
                                <input type="submit" value="Change"/>
                            </div>
                        </form>
                        {% endif %}
                    </td>
                    {% if not ua.date_deleted and is_admin %}
                        <td><a class="deletelink" href="{% url 'kg_account_delete' ua.id %}">Delete</a></td>
                    {% endif %}
                </tr>
            </tbody>
        </table>

        {% if ua.project_list and not ua.date_deleted %}
        <h3>Projects</h3>
        <table cellspacing="0">
            <thead>
                <tr>
                    <th>Project</th>
                    <th>Name</th>
                    <th>Institute</th>
                    <th>Leaders</th>
                    <th>Default</th>
                </tr>
            </thead>
            <tbody>
            {% for p in ua.project_list %}
            <tr class="{% cycle row1,row2 %}">
                <td><a href="{{ p.get_absolute_url }}">{{ p.pid }}</a></td>
                <td>{{ p.name|truncatewords:"10" }}</td>
                <td><a href="{{ p.institute.get_absolute_url }}">{{ p.institute }}</a></td>
                <td>{% for leader in p.leaders.all %}<a href="{{ leader.get_absolute_url }}">{{ leader }}, </a>{% endfor %}</td>
                <td>
                    {% ifequal p ua.default_project %}
                    <img alt="1" src="{{ STATIC_URL }}img/icon-yes.gif"/>{% else %}
                    {% if is_admin %}
                    <form action="{% url 'kg_account_set_default' ua.id p.pid %}" method="post">
                        {% csrf_token %}
                        <input type="submit" value="Make Default"/></input>
                    </form>
                    {% endif %}{% endifequal %}
                </td>
                <td>
                    {% if is_admin %}{% ifnotequal p ua.default_project %}
                    <a class="deletelink" href="{% url 'kg_remove_project_member' p.pid person.username %}">Remove</a>
                    {% endifnotequal %}{% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if ua.get_latest_usage %}
        <h3>Latest Usage</h3>
        {% gen_table ua.get_latest_usage usage/user_table.html %}
        {% endif %}

        {% if is_admin and person.is_active %}
        <h3>Account actions</h3>
        <div class="object-tools">
            <ul>
                <li><a href="{% url 'kg_usage_job_list' %}?account={{ ua.username }}">Display all jobs</a></li>
                <li class="addlink"><a href="{% url 'kg_person_add_account' person.username %}">Add account</a></li>
            </ul>
        </div>
        {% endif %}
    </div>
    {% endfor %}

    {% if person.account_set.all and person.is_active and is_admin %}
    <div class="module">
        <h2>Add to Project</h2>
        <form action="" id="joinproject_form" method="post">{% csrf_token %}
            <div class="form-row">
                {{ form }}
                <input name="project-add" type="submit" value="Add"/>
            </div>
        </form>
    </div>
    {% endif %}

    {% if person.softwarelicenseagreement_set.all and is_admin %}
    <div class="module">
        <h2>Software</h2>
        {% gen_table person.softwarelicenseagreement_set.all %}
    </div>
    {% endif %}

    {% if is_admin %}
    <div class="module">
        <h2>Comments</h2>
        {% comments person %}
        <h3>Comment actions</h3>
        <div class="object-tools">
            <ul>
                <li class="addlink"><a href="{% url 'kg_person_add_comment' person.username %}">Add comment</a></li>
            </ul>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}


{% block object-tools %}
{% endblock %}
